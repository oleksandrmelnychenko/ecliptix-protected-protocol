name: Build and Publish Mobile Packages

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version override (e.g., 1.0.0)'
        required: false
        type: string

permissions:
  contents: write
  packages: write

env:
  IOS_DEPLOYMENT_TARGET: '17.0'
  ANDROID_API_LEVEL: '34'
  ANDROID_NDK_VERSION: '26.2.11394342'
  GRADLE_VERSION: '8.7'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_release: ${{ steps.version.outputs.is_release }}
    steps:
      - id: version
        run: |
          if [[ "${{ github.event.inputs.version }}" != "" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION="1.0.0-ci.${{ github.run_number }}"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "is_release=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_release=false" >> "$GITHUB_OUTPUT"
          fi

  build-ios:
    needs: prepare
    runs-on: macos-14
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
      VCPKG_ROOT: ${{ github.workspace }}/.build/vcpkg
    steps:
      - uses: actions/checkout@v4

      - name: Install build tools
        run: |
          brew install cmake ninja pkg-config

      - name: Build XCFramework
        run: |
          bash bindings/swift/build-ios.sh

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-xcframework
          path: |
            bindings/swift/artifacts/EcliptixProtocolC.xcframework.zip
            bindings/swift/artifacts/EcliptixProtocolC.xcframework.checksum

  build-android:
    needs: prepare
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
      VCPKG_ROOT: ${{ github.workspace }}/.build/vcpkg
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK/NDK
        uses: android-actions/setup-android@v3
        with:
          packages: |
            platform-tools
            platforms;android-${{ env.ANDROID_API_LEVEL }}
            ndk;${{ env.ANDROID_NDK_VERSION }}

      - name: Configure NDK path
        run: |
          SDK_ROOT="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          echo "ANDROID_NDK_HOME=$SDK_ROOT/ndk/${{ env.ANDROID_NDK_VERSION }}" >> "$GITHUB_ENV"
          echo "ANDROID_NDK_ROOT=$SDK_ROOT/ndk/${{ env.ANDROID_NDK_VERSION }}" >> "$GITHUB_ENV"

      - name: Build native library
        run: |
          bash bindings/android/build-android.sh

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: ${{ env.GRADLE_VERSION }}

      - name: Assemble AAR
        run: |
          gradle -p bindings/android :ecliptix-protocol:assembleRelease

      - name: Publish to GitHub Packages
        if: needs.prepare.outputs.is_release == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gradle -p bindings/android :ecliptix-protocol:publish

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-aar
          path: bindings/android/ecliptix-protocol/build/outputs/aar/ecliptix-protocol-release.aar

  update-spm:
    needs: [prepare, build-ios]
    if: needs.prepare.outputs.is_release == 'true'
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
      DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}

      - name: Download iOS checksum
        uses: actions/download-artifact@v4
        with:
          name: ios-xcframework
          path: ios-artifacts

      - name: Update Package.swift
        run: |
          CHECKSUM="$(cat ios-artifacts/EcliptixProtocolC.xcframework.checksum)"
          bash bindings/swift/update-package.sh "$VERSION" "$CHECKSUM"

      - name: Commit Package.swift update
        run: |
          if git diff --quiet; then
            echo "No Package.swift changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Package.swift
          git commit -m "Update Swift package for v$VERSION"
          git push origin "HEAD:$DEFAULT_BRANCH"

  release:
    needs: [prepare, build-ios, build-android]
    if: needs.prepare.outputs.is_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download iOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: ios-xcframework
          path: ios-artifacts

      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-aar
          path: android-artifacts

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ios-artifacts/EcliptixProtocolC.xcframework.zip
            android-artifacts/ecliptix-protocol-release.aar
